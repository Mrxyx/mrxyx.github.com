<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Android内存优化 | 知,行|Mrx 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Mrx">
    
    

    <meta name="description" content="本章参考google官方文档，总结了android开发过程中内存优化的方法，同时，结合实际开发过程中遇到的OOM，总结了部分经验。不当之处，请随时提出。">
<meta name="keywords" content="内存,优化">
<meta property="og:type" content="article">
<meta property="og:title" content="Android内存优化 | 知,行|Mrx">
<meta property="og:url" content="http://www.mrxyx.cn/2017/05/09/Android内存优化/index.html">
<meta property="og:site_name" content="知,行|Mrx">
<meta property="og:description" content="本章参考google官方文档，总结了android开发过程中内存优化的方法，同时，结合实际开发过程中遇到的OOM，总结了部分经验。不当之处，请随时提出。">
<meta property="og:image" content="https://raw.githubusercontent.com/Mrxyx/MarkPhotos/master/Res/2017050901.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Mrxyx/MarkPhotos/master/Res/2017050902.png">
<meta property="og:updated_time" content="2017-05-09T12:56:18.850Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android内存优化 | 知,行|Mrx">
<meta name="twitter:description" content="本章参考google官方文档，总结了android开发过程中内存优化的方法，同时，结合实际开发过程中遇到的OOM，总结了部分经验。不当之处，请随时提出。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Mrxyx/MarkPhotos/master/Res/2017050901.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">知,行|Mrx</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          梦想星辰大海的人，注定孤独
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <li class="navigation__item">
        <a href="https://github.com/Mrxyx" title="Huno on GitHub">
          <i class='icon icon-social-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    

    <!-- China social icon -->
    <!--
    
      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-douban'></i>
          <span class="label">Douban</span>
        </a>
      </li>

      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-weibo'></i>
          <span class="label">Weibo</span>
        </a>
      </li>

    -->



  </ul>
</nav>



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Android内存优化</h1>

    

    <div class="post-meta">
      <time datetime="2017-05-09" class="post-meta__date date">2017-05-09</time> 
	 <span id="busuanzi_container_page_pv" class="post-meta__date date">|&nbsp;&nbsp;viewed <span id="busuanzi_value_page_pv"></span> 次</span>
      <span class="post-meta__tags tags">

          
            <font class="categories">
            &#8226; 分类:
            <a class="categories-link" href="/categories/Android/">Android</a>
            </font>
          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/优化/">优化</a>, <a class="tags-link" href="/tags/内存/">内存</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>本章参考google官方文档，总结了android开发过程中内存优化的方法，同时，结合实际开发过程中遇到的OOM，总结了部分经验。不当之处，请随时提出。<br><a id="more"></a></p>
<blockquote>
<p>Random-access memory (RAM) is a valuable resource in any software development environment,<br>but it’s even more valuable on a mobile operating system where physical memory is often constrained.<br>Although both the Android Runtime (ART) and Dalvik virtual machine perform routine garbage collection,<br>this does not mean you can ignore when and where your app allocates and releases memory</p>
</blockquote>
<p>随机存取存储器（RAM）是任何软件开发环境中的宝贵资源，但在物理内存通常受限制的移动操作系统上更为有价值。<br>尽管Android Runtime（ART）和Dalvik虚拟机都执行常规垃圾收集，但这并不意味着您可以忽略应用程序分配和释放内存的时间和位置</p>
<h2 id="查看内存使用情况"><a href="#查看内存使用情况" class="headerlink" title="查看内存使用情况"></a>查看内存使用情况</h2><ul>
<li>1 使用android studio自带的 Memory Monitor查看<br>该工具显示可用和分配的Java内存随时间的图，包括垃圾回收事件<br><img src="https://raw.githubusercontent.com/Mrxyx/MarkPhotos/master/Res/2017050901.png" alt=""></li>
<li>2 使用android studio自带的allocation Tracker tool<br>分配跟踪器记录应用程序的内存分配，并列出分析快照中的所有已分配对象。您可以使用此工具来跟踪分配太多对象的部分代码<br><img src="https://raw.githubusercontent.com/Mrxyx/MarkPhotos/master/Res/2017050902.png" alt=""></li>
</ul>
<h2 id="优化内存的方案"><a href="#优化内存的方案" class="headerlink" title="优化内存的方案"></a>优化内存的方案</h2><h4 id="1-使用onTrimMemory在应用UI隐藏时释放UI资源来释放内存"><a href="#1-使用onTrimMemory在应用UI隐藏时释放UI资源来释放内存" class="headerlink" title="1 使用onTrimMemory在应用UI隐藏时释放UI资源来释放内存"></a>1 使用onTrimMemory在应用UI隐藏时释放UI资源来释放内存</h4><p>请注意：这个玩意不同于onStop，你的应用仅仅会在所有UI组件的被隐藏的时候接收到onTrimMemory()的回调并带有参数TRIM_MEMORY_UI_HIDDEN。<br>这与onStop()的回调是不同的，onStop会在activity的实例隐藏时会执行，例如当用户从你的app的某个activity跳转到另外一个activity时前面activity的onStop()会被执行。<br>因此你应该实现onStop回调，并且在此回调里面释放activity的资源，例如释放网络连接，注销监听广播接收者。除非接收到onTrimMemory(TRIM_MEMORY_UI_HIDDEN))的回调，<br>否者你不应该释放你的UI资源。这确保了用户从其他activity切回来时，你的UI资源仍然可用，并且可以迅速恢复activity。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">import android.content.ComponentCallbacks2;</div><div class="line">// Other import statements ...</div><div class="line"></div><div class="line">public class MainActivity extends AppCompatActivity</div><div class="line">    implements ComponentCallbacks2 &#123;</div><div class="line"></div><div class="line">    // Other activity code ...</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Release memory when the UI becomes hidden or when system resources become low.</div><div class="line">     * @param level the memory-related event that was raised.</div><div class="line">     */</div><div class="line">    public void onTrimMemory(int level) &#123;</div><div class="line"></div><div class="line">        // Determine which lifecycle or system event was raised.</div><div class="line">        switch (level) &#123;</div><div class="line"></div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN:</div><div class="line"></div><div class="line">                /*</div><div class="line">                   Release any UI objects that currently hold memory.</div><div class="line"></div><div class="line">                   The user interface has moved to the background.</div><div class="line">                */</div><div class="line"></div><div class="line">                break;</div><div class="line">	    //你的app正在运行并且不会被列为可杀死的。但是设备此时正运行于低内存状态下，系统开始触发杀死LRU Cache中的Process的机制</div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_RUNNING_MODERATE:	</div><div class="line"></div><div class="line">		break;</div><div class="line">	    //你的app正在运行且没有被列为可杀死的。但是设备正运行于更低内存的状态下，你应该释放不用的资源用来提升系统性能（但是这也会直接影响到你的app的性能）。</div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_RUNNING_LOW:</div><div class="line"></div><div class="line">		break;</div><div class="line">	    //你的app仍在运行，但是系统已经把LRU Cache中的大多数进程都已经杀死，因此你应该立即释放所有非必须的资源。如果系统不能回收到足够的RAM数量，</div><div class="line">		//系统将会清除所有的LRU缓存中的进程，并且开始杀死那些之前被认为不应该杀死的进程，例如那个包含了一个运行态Service的进程。</div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_RUNNING_CRITICAL:</div><div class="line"></div><div class="line">                /*</div><div class="line">                   Release any memory that your app doesn&apos;t need to run.</div><div class="line"></div><div class="line">                   The device is running low on memory while the app is running.</div><div class="line">                   The event raised indicates the severity of the memory-related event.</div><div class="line">                   If the event is TRIM_MEMORY_RUNNING_CRITICAL, then the system will</div><div class="line">                   begin killing background processes.</div><div class="line">                */</div><div class="line"></div><div class="line">                break;</div><div class="line">	    //系统正运行于低内存状态并且你的进程正处于LRU缓存名单中最不容易杀掉的位置。尽管你的app进程并不 是处于被杀掉的高危险状态，</div><div class="line">	    //系统可能已经开始杀掉LRU缓存中的其他进程了。你应该释放那些容易恢复的资源，以便于你的进程可以保留下来，这样当用户回退到你的app的时候才能够迅速恢复。</div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_BACKGROUND:</div><div class="line"></div><div class="line">		break;</div><div class="line">	    //系统正运行于低内存状态并且你的进程已经已经接近LRU名单的中部位置。如果系统开始变得更加内存紧张，你的进程是有可能被杀死的</div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_MODERATE:</div><div class="line"></div><div class="line">		break;</div><div class="line">	    //系统正运行与低内存的状态并且你的进程正处于LRU名单中最容易被杀掉的位置。你应该释放任何不影响你的app恢复状态的资源</div><div class="line">            case ComponentCallbacks2.TRIM_MEMORY_COMPLETE:</div><div class="line"></div><div class="line">                /*</div><div class="line">                   Release as much memory as the process can.</div><div class="line"></div><div class="line">                   The app is on the LRU list and the system is running low on memory.</div><div class="line">                   The event raised indicates where the app sits within the LRU list.</div><div class="line">                   If the event is TRIM_MEMORY_COMPLETE, the process will be one of</div><div class="line">                   the first to be terminated.</div><div class="line">                */</div><div class="line"></div><div class="line">                break;</div><div class="line"></div><div class="line">            default:</div><div class="line">                /*</div><div class="line">                  Release any non-critical data structures.</div><div class="line"></div><div class="line">                  The app received an unrecognized memory level value</div><div class="line">                  from the system. Treat this as a generic low-memory message.</div><div class="line">                */</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>这个回调支持API14以上，要兼容14以下可以使用 onLowMemory()</p>
</blockquote>
<h4 id="2-谨慎使用services-可以选择intentservice-代替service"><a href="#2-谨慎使用services-可以选择intentservice-代替service" class="headerlink" title="2 谨慎使用services,可以选择intentservice 代替service"></a>2 谨慎使用services,可以选择intentservice 代替service</h4><p> 它会在处理完交代给它的intent任务之后尽快结束自己</p>
<h4 id="3-使用ArrayMap-SparseArray代替hashmap等传统数据结构"><a href="#3-使用ArrayMap-SparseArray代替hashmap等传统数据结构" class="headerlink" title="3 使用ArrayMap/SparseArray代替hashmap等传统数据结构"></a>3 使用ArrayMap/SparseArray代替hashmap等传统数据结构</h4><h4 id="4-注意代码抽象，少用enum"><a href="#4-注意代码抽象，少用enum" class="headerlink" title="4 注意代码抽象，少用enum"></a>4 注意代码抽象，少用enum</h4><p>抽象的代价是巨大的：一般来说，它们需要更多的代码需要执行，需要更多的时间和更多的RAM才能将该代码映射到内存中</p>
<blockquote>
<p>For example, enums often require more than twice as much memory as static constants. You should strictly avoid using enums on Android</p>
</blockquote>
<h4 id="5-谨慎使用第三方库，移除内存使用大的库和资源文件"><a href="#5-谨慎使用第三方库，移除内存使用大的库和资源文件" class="headerlink" title="5 谨慎使用第三方库，移除内存使用大的库和资源文件"></a>5 谨慎使用第三方库，移除内存使用大的库和资源文件</h4><p> 你的代码中的一些资源和库可以在不知道的情况下消除内存。<br> 您的APK的总体尺寸（包括第三方库或嵌入式资源）可能会影响应用程序消耗多少内存。<br> 您可以通过从代码中删除任何冗余的，不必要的或膨胀的组件，资源或库来提高应用程序的内存消耗</p>
<h4 id="6-减小APk大小"><a href="#6-减小APk大小" class="headerlink" title="6 减小APk大小"></a>6 减小APk大小</h4><p> 您可以通过减少应用程序的总体大小来显着降低应用程序的内存使用量。<br> 位图大小，资源，动画框架和第三方库都可以帮助您的APK的大小。<br> Android Studio和Android SDK提供多种工具来帮助您减少资源和外部依赖关系的大小<br> example <a href="https://developer.android.google.cn/topic/performance/reduce-apk-size.html" target="_blank" rel="external">Reduce APK Size</a></p>
<h4 id="7-如果项目必须需要用到依赖注入框架，推荐使用Dragger2-官方推荐"><a href="#7-如果项目必须需要用到依赖注入框架，推荐使用Dragger2-官方推荐" class="headerlink" title="7 如果项目必须需要用到依赖注入框架，推荐使用Dragger2(官方推荐)"></a>7 如果项目必须需要用到依赖注入框架，推荐使用<a href="https://google.github.io/dagger/" target="_blank" rel="external">Dragger2</a>(官方推荐)</h4><p> Dagger不使用反射来扫描您的应用程序的代码。 Dagger的静态编译时实现意味着它可以在Android应用程序中使用，而无需运行时费用或内存使用。</p>
<h4 id="8-使用LeakCanary开源控件，可以很好的帮助我们发现内存泄露的情况"><a href="#8-使用LeakCanary开源控件，可以很好的帮助我们发现内存泄露的情况" class="headerlink" title="8 使用LeakCanary开源控件，可以很好的帮助我们发现内存泄露的情况"></a>8 使用LeakCanary开源控件，可以很好的帮助我们发现内存泄露的情况</h4><p> 具体的使用请查看<a href="https://github.com/square/leakcanary" target="_blank" rel="external">官方Github</a>或者<a href="https://www.liaohuqiu.net/cn/posts/leak-canary-read-me/" target="_blank" rel="external">中文资料</a><br> 当然还可以使用MAT</p>
<p> 以上参考自<a href="https://developer.android.google.cn/topic/performance/memory.html" target="_blank" rel="external">android官方性能优化资料</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>LeakCanary值得推荐，用于监听项目中的内存泄露。<br>监听会发现除了官方SDK中的方法导致的内存泄露外，大部分都是静态变量的引用未及时销毁导致的。</li>
<li>加载大图，及易产生OOM。<br>因此在加载图片的时候，需要我们对图片进行压缩处理（图片的大小，质量压缩），选择合适尺寸的图片进行加载。同时，需要及时recycle临时图片。</li>
<li>减少不必要的全局变量（官方文档给出了同样的建议），避免静态变量引用消耗更多的资源。</li>
<li>减少枚举类型的使用。</li>
<li>在使用SQLite时及时销毁cursor。<br>以上为项目中遇到的内存优化方案，其他方案若有遗漏会及时补充。</li>
</ul>
<p>插一句：虽然现在手机内存慢慢在变大，必要的时候，我们可以使用空间换时间，但是在自己能力范围内，不断的优化内存使用，应该算是我们的职业道德吧👍。</p>
<p>虽然我现在是渣渣，但是五年后呢？嘻嘻</p>

  </section>

  
  
  
<section class="post-comments">
<div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
<script>
  var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "",
    productKey: "33bdbc28951e4ef7a555f39a875c878a",
    target: "cloud-tie-wrapper"
  };
</script>
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
</section>

  
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a> | 本站总点击<span id="busuanzi_value_site_pv"></span>次 | 您是第<span id="busuanzi_value_site_uv"></span>位访客</span>
   

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?99d62de6b248a2fbdf4b9deb88ec07dc";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
